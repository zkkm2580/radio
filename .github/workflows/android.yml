name: Build Android APK

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1️⃣ 检出仓库
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ 缓存 pip 包
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 3️⃣ 安装系统依赖
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y openjdk-17-jdk unzip zip wget python3-pip python3-venv build-essential

          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH

      # 4️⃣ 缓存 Android SDK
      - name: Cache Android SDK
        uses: actions/cache@v3
        with:
          path: $HOME/android-sdk
          key: ${{ runner.os }}-android-sdk
          restore-keys: |
            ${{ runner.os }}-android-sdk

      # 5️⃣ 安装 Android SDK
      - name: Install Android SDK
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH

          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH

          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools

          if [ ! -d "latest" ]; then
            wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_33.0.2.zip
            unzip commandlinetools-linux-*.zip
            mv cmdline-tools 33.0.2
          fi

          mkdir -p $ANDROID_HOME/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license

          sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      # 6️⃣ 安装 Buildozer 和 Cython
      - name: Install Buildozer
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install buildozer cython

      # 7️⃣ 构建 APK
      - name: Build APK
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH

          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH

          buildozer android debug

      # 8️⃣ 上传 APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: RadioPlayer-APK
          path: bin/*.apk
